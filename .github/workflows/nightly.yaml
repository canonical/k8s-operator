name: Nightly Tests

on:
  schedule:
    - cron: "0 0 * * *" # Runs every midnight
  pull_request:
    paths:
      - .github/workflows/nightly.yaml

permissions:
  contents: read

jobs:
  integration-tests-terraform:
    strategy:
      matrix:
        test: [default, ceph]
        include:
          - test: default
            test_name: test_k8s
            manifest-yaml: ${{ github.workspace }}/tests/integration/data/default-manifest.yaml
            env: {}
          - test: ceph
            test_name: test_ceph
            manifest-yaml: ${{ github.workspace }}/tests/integration/data/ceph-manifest.yaml
            env:
              TF_VAR_csi_integration: "ceph"
    name: integration-tests-terraform-${{ matrix.test }}
    runs-on: self-hosted-linux-amd64-jammy-xlarge
    steps:
    - name: Setup operator environment
      uses: charmed-kubernetes/actions-operator@main
      with:
        provider: lxd
        channel: latest/stable
        juju-channel: 3/stable
    - name: Checking out repo
      uses: actions/checkout@v4
    - name: Setup cluster with terraform
      env: ${{ matrix.env }}
      run: |
        tox -e deploy-terraform -- --model my-canonical-k8s --manifest-yaml ${{ matrix.manifest-yaml }}
    - name: Run integration tests
      run: |
        tox -e integration -- -s -k ${{ matrix.test_name }} --model my-canonical-k8s --no-deploy
    - name: Setup tmate session
      if: ${{ failure() }}
      uses: canonical/action-tmate@main
