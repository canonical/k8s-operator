name: Nightly Tests

on:
  schedule:
    - cron: "0 0 * * *" # Runs every midnight
  pull_request:
    paths:
      - .github/workflows/nightly.yaml

permissions:
  contents: read

jobs:
  integration-tests-terraform:
    strategy:
      matrix:
        test: [ceph]
    name: integration-tests-terraform-${{ matrix.test }}
    runs-on: self-hosted-linux-amd64-jammy-xlarge
    steps:
    - name: Setup operator environment
      uses: charmed-kubernetes/actions-operator@main
      with:
        provider: lxd
        channel: latest/stable
        juju-channel: 3/stable
    - name: Checking out repo
      uses: actions/checkout@v4
    - name: Setup cluster with terraform
      run: |
        tox -e deploy-terraform -- --model my-canonical-k8s --manifest-yaml tests/integration/data/${{ matrix.test }}-manifest.yaml
    - name: Run integration tests
      run: |
        tox -e integration -- -s -k test_${{ matrix.test }} --model my-canonical-k8s --no-deploy
    - name: Setup tmate session
      if: ${{ failure() }}
      uses: canonical/action-tmate@main
