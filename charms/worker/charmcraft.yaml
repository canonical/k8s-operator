# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.
# This file configures Charmcraft.
# See https://juju.is/docs/sdk/charmcraft-config for guidance.

name: k8s-worker
title: Kubernetes Worker
summary: A machine charm for a K8s Worker
description: |
  A machine charm which operates a Kubernetes worker.

  This charm installs and operates a Kubernetes worker via the k8s snap. It exposes
  relations to co-operate with other kubernetes components

  This charm provides the following running components:
  * kube-proxy
  * kubelet
  * containerd
links:
  contact: https://launchpad.net/~containers
  documentation: https://discourse.charmhub.io/t/k8s-worker-docs-index/13135
  issues:
  - https://github.com/canonical/k8s-operator/issues
  source:
    - https://github.com/canonical/k8s-operator

assumes:
  - juju >= 3.3

type: charm
platforms:
  ubuntu-20.04-amd64:
    build-on:
      - ubuntu@20.04:amd64
    build-for:
      - ubuntu@20.04:amd64
  ubuntu-20.04-arm64:
    build-on:
      - ubuntu@20.04:arm64
    build-for:
      - ubuntu@20.04:arm64

  ubuntu-22.04-amd64:
    build-on:
      - ubuntu@22.04:amd64
    build-for:
      - ubuntu@22.04:amd64
  ubuntu-22.04-arm64:
    build-on:
      - ubuntu@22.04:arm64
    build-for:
      - ubuntu@22.04:arm64

  ubuntu-24.04-amd64:
    build-on:
      - ubuntu@24.04:amd64
    build-for:
      - ubuntu@24.04:amd64
  ubuntu-24.04-arm64:
    build-on:
      - ubuntu@24.04:arm64
    build-for:
      - ubuntu@24.04:arm64

config:
  options:
    bootstrap-certificates:
      type: string
      default: "self-signed"
      description: |
        The type of certificates to use in Canonical Kubernetes. This cannot be
        changed after deployment. Allowed values are "self-signed" and "external".
    bootstrap-node-taints:
      type: string
      default: ""
      description: |
        Space-separated list of taints to apply to this node at registration time.

        This config is only used at bootstrap time when Kubelet first registers the
        node with Kubernetes. To change node taints after deploy time, use kubectl
        instead.

        For more information, see the upstream Kubernetes documentation about
        taints:
        https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/
    node-labels:
      default: ""
      type: string
      description: |
        Labels can be used to organize and to select subsets of nodes in the
        cluster. Declare node labels in key=value format, separated by spaces.
        
        Note: Due to NodeRestriction, workers are limited to how they can label themselves
        https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction
    kube-proxy-extra-args:
      type: string
      default: ""
      description: |
        Space separated list of flags and key=value pairs that will be passed as arguments to
        kube-proxy.

        Notes:
          Options may only be set on charm deployment

        For example a value like this:
          runtime-config=batch/v2alpha1=true profiling=true
        will result in kube-proxy being run with the following options:
          --runtime-config=batch/v2alpha1=true --profiling=true
    kubelet-extra-args:
      type: string
      default: ""
      description: |
        Space separated list of flags and key=value pairs that will be passed as arguments to
        kubelet.

        Notes:
          Options may only be set on charm deployment

        For example a value like this:
          runtime-config=batch/v2alpha1=true profiling=true
        will result in kubelet being run with the following options:
          --runtime-config=batch/v2alpha1=true --profiling=true

resources:
  snap-installation:
    type: file
    filename: snap-installation.tar.gz
    description: |
      Override charm defined snap installation script

      This charm is designed to operate with a specific revision of snaps, overriding 
      with anything will indicate that the charm is running an unsupported configuration.

      Content Options:
      0-byte resource (Default) -- Use the charm defined snap installation script
      ./snap-installation.yaml  -- Overrides the charm defined snap-installation.yaml
      ./k8s_XXXX.snap           -- Overrides the charm with a specific snap file installed dangerously

parts:
  charm:
    plugin: charm
    build-packages:
      - git
      - libffi-dev
      - libssl-dev
      - pkg-config
      - rustc
      - cargo
    charm-entrypoint: k8s/src/charm.py
    charm-requirements: [k8s/requirements.txt]
  promote:
    # move paths out of ./k8s to ./ since 
    # charmcraft assumes ./lib to be there
    # charmcraft assumes ./templates to be there
    after: [charm]
    plugin: nil
    source: ./
    override-prime: |
      rm -rf $CRAFT_PRIME/lib $CRAFT_PRIME/templates
      mv $CRAFT_PRIME/k8s/lib $CRAFT_PRIME/lib
      mv $CRAFT_PRIME/k8s/templates $CRAFT_PRIME/templates
actions:
  pre-upgrade-check:
    description: Run necessary pre-upgrade checks before executing a charm upgrade.

peers:
  upgrade:
    interface: upgrade


provides:
  cos-agent:
    interface: cos_agent

requires:
  aws:
    interface: aws-integration
  azure:
    interface: azure-integration
  certificates:
    interface: tls-certificates
  cluster:
    interface: k8s-cluster
    # interface to connect with the k8s charm to provide
    # authentication token via a secret in order to cluster
    # this machine as a worker unit.
    #   juju integrate k8s:k8s-cluster k8s-worker:cluster
  cos-tokens:
    interface: cos-k8s-tokens
  containerd:
    interface: containerd
  gcp:
    interface: gcp-integration
